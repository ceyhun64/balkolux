generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma" // schema.prisma'ya g√∂re relative
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Review {
  id        Int      @id @default(autoincrement())
  rating    Int
  title     String?
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  userId    Int
  productId Int
  product   product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId], map: "Review_productId_fkey")
  @@map("review")
}

model User {
  id                Int        @id @default(autoincrement())
  name              String
  surname           String
  email             String     @unique
  password          String
  phone             String?
  role              UserRole   @default(USER)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  resetToken        String? // nullable
  resetTokenExpires DateTime? // nullable
  addresses         Address[]
  favorites         Favorite[]
  orders            Order[]
  Review            Review[]

  @@map("user")
}

model Favorite {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  createdAt DateTime @default(now())
  product   product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId], map: "Favorite_productId_fkey")
  @@map("favorite")
}

model CartItem {
  id        Int      @id @default(autoincrement())
  userId    Int? // nullable, guest cart i√ßin
  productId Int
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId], map: "CartItem_productId_fkey")
  @@map("cartitem")
}

model Address {
  id           Int      @id @default(autoincrement())
  userId       Int
  title        String
  firstName    String
  lastName     String
  address      String
  neighborhood String?
  district     String
  city         String
  tcno         String?  @db.VarChar(11)
  zip          String
  phone        String
  country      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "Address_userId_fkey")
  @@map("address")
}

model Order {
  id             Int            @id @default(autoincrement())
  userId         Int
  status         OrderStatus    @default(pending)
  totalPrice     Int
  paidPrice      Int
  currency       String
  installment    Int            @default(1) // Taksit sayƒ±sƒ± (tek √ßekim ise 1)
  iyziPaymentId  String? // Iyzico'dan d√∂nen paymentId (ƒ∞ptal/ƒ∞ade i√ßin ≈üart)
  paymentMethod  String
  transactionId  String?
  couponCode     String? // üéüÔ∏è Kullanƒ±lan kupon kodu
  discountAmount Float?         @default(0) // üéüÔ∏è ƒ∞ndirim tutarƒ±
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  addresses      OrderAddress[]
  items          OrderItem[]

  @@index([userId], map: "Order_userId_fkey")
  @@index([couponCode], map: "Order_couponCode_idx") // üéüÔ∏è Kupon sorgularƒ± i√ßin index
  @@map("order")
}

model OrderItem {
  id                Int     @id @default(autoincrement())
  orderId           Int
  productId         Int
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  iyziTransactionId String? // Kƒ±smi iade i≈ülemleri i√ßin hayat kurtarƒ±r

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product product @relation(fields: [productId], references: [id])

  @@index([orderId], map: "OrderItem_orderId_fkey")
  @@index([productId], map: "OrderItem_productId_fkey")
  @@map("orderitem")
}

model OrderAddress {
  id        Int     @id @default(autoincrement())
  orderId   Int
  type      String
  firstName String
  lastName  String
  address   String
  district  String
  tcno      String? @db.VarChar(11)
  city      String
  zip       String
  phone     String
  country   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId], map: "OrderAddress_orderId_fkey")
  @@map("orderaddress")
}

model Blog {
  id        Int      @id @default(autoincrement())
  title     String
  content   String   @db.Text
  image     String
  category  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blog")
}

model Category {
  id            Int           @id @default(autoincrement())
  name          String
  subCategories SubCategory[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  product       product[]

  @@map("category")
}

model SubCategory {
  id         Int       @id @default(autoincrement())
  name       String
  categoryId Int
  category   Category  @relation(fields: [categoryId], references: [id])
  products   product[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@map("sub_category")
}


model product {
  id                 Int     @id @default(autoincrement())
  title              String
  price              Int
  oldPrice           Int? // Eski fiyat (indirimden √∂nceki fiyat)
  discountPercentage Int? // ƒ∞ndirim y√ºzdesi (√∂rn: 30 = %30 indirim)
  rating             Int
  reviewCount        Int?
  mainImage          String  @default("default-image.jpg")
  subImage           String?
  subImage2          String?
  subImage3          String?
  subImage4          String?
  description        String

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  subCategoryId Int?
  subCategory   SubCategory? @relation(fields: [subCategoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  CartItem  CartItem[]
  Favorite  Favorite[]
  OrderItem OrderItem[]
  Review    Review[]
}

model Subscribe {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscribe")
}

model Banner {
  id       Int     @id @default(autoincrement())
  title    String?
  subtitle String?
}

model Coupon {
  id    String     @id @default(cuid())
  code  String     @unique // Kullanƒ±cƒ±nƒ±n gireceƒüi kod (√ñrn: SUMMER20)
  type  CouponType // PERCENTAGE veya FIXED
  value Float // ƒ∞ndirim miktarƒ± (%20 i√ßin 20, 100 TL i√ßin 100)

  // Opsiyonel Kƒ±sƒ±tlamalar
  minAmount   Float? // Minimum sepet tutarƒ± (Bu tutar altƒ±ndaysa kupon ge√ßersiz)
  maxDiscount Float? // Y√ºzdelik indirimde maksimum d√º≈ü√ºlecek tutar (Opsiyonel)

  // Kontrol Alanlarƒ±
  isActive   Boolean   @default(true)
  usageLimit Int? // Toplam ka√ß kez kullanƒ±labilir?
  usedCount  Int       @default(0)
  expiryDate DateTime? // Son kullanma tarihi

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code], map: "Coupon_code_idx") // üéüÔ∏è Kod aramalarƒ± i√ßin index
  @@index([isActive], map: "Coupon_isActive_idx") // üéüÔ∏è Aktif kupon sorgularƒ± i√ßin
  @@map("coupons")
}

enum CouponType {
  PERCENTAGE
  FIXED
}

enum OrderStatus {
  pending
  paid
  shipped
  delivered
  cancelled
}

enum UserRole {
  USER
  ADMIN
}
